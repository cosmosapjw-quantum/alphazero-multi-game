FROM nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04 AS deps

ENV DEBIAN_FRONTEND=noninteractive

# Core build tools and Python libs
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential git wget unzip ca-certificates \
        libopenblas-dev ninja-build pkg-config gdb valgrind \
        python3-dev python3-pip patch \
        nlohmann-json3-dev \
        pybind11-dev \
        python3-sympy python3-networkx python3-jinja2 \
        python3-filelock python3-fsspec python3-requests && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Git config
RUN git config --global http.sslVerify true && \
    git config --global http.sslCAinfo /etc/ssl/certs/ca-certificates.crt

# Modern CMake and pip
RUN python3 -m pip install --no-cache-dir --upgrade \
        pip setuptools wheel cmake==3.29.*

ENV PIP_DEFAULT_TIMEOUT=120 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# PyTorch & torchvision
ARG TORCH_VER=2.1.0
ARG CUDA_TAG=cu121
RUN pip install --no-cache-dir --retries 5 \
        torch==${TORCH_VER}+${CUDA_TAG} \
        torchvision==0.16.0+${CUDA_TAG} \
        --extra-index-url https://download.pytorch.org/whl/${CUDA_TAG}

# LibTorch C++ distribution
RUN mkdir -p /opt && \
    wget -q https://download.pytorch.org/libtorch/${CUDA_TAG}/libtorch-cxx11-abi-shared-with-deps-${TORCH_VER}%2B${CUDA_TAG}.zip \
        -O /tmp/libtorch.zip && \
    unzip -q /tmp/libtorch.zip -d /opt && rm /tmp/libtorch.zip
ENV TORCH_DIR=/opt/libtorch
ENV LD_LIBRARY_PATH="/opt/libtorch/lib:${LD_LIBRARY_PATH}"

# Extra Python utilities
RUN pip install --no-cache-dir \
        numpy matplotlib tqdm tensorboard \
        pybind11==2.10.4

# Build stage - copy & build the project with tests
WORKDIR /src

# Copy project sources
COPY . .

# Create a patch to fix the install problem in CMakeLists.txt
COPY fix-cmakefile.patch /tmp/fix-install.patch

# Patch CMakeLists.txt to fix install exports
RUN patch -p1 < /tmp/fix-install.patch || echo "Warning: patch may have partially failed"

# Patch CMakeLists.txt for system dependencies
RUN <<'EOF' > /tmp/az_patch.diff
diff --git a/CMakeLists.txt b/CMakeLists.txt
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@
 find_package(Torch REQUIRED)
+# ─── Torch-target compatibility (torch ≥ 2.0 dropped Torch::Torch) ──────────
+if(NOT TARGET Torch::Torch AND TARGET torch)
+    add_library(Torch::Torch ALIAS torch)
+endif()
+
-include(FetchContent)
-FetchContent_Declare(
-    nlohmann_json
-    GIT_REPOSITORY https://github.com/nlohmann/json.git
-    GIT_TAG        v3.11.2
-)
-FetchContent_MakeAvailable(nlohmann_json)
+# Find nlohmann_json system package or create an imported target
+if(NOT TARGET nlohmann_json::nlohmann_json)
+    find_package(nlohmann_json CONFIG QUIET)
+endif()
+
+# If not found via find_package, create an imported target manually
+if(NOT TARGET nlohmann_json::nlohmann_json)
+    find_path(NLOHMANN_JSON_INCLUDE_DIR nlohmann/json.hpp REQUIRED)
+    add_library(nlohmann_json INTERFACE IMPORTED)
+    target_include_directories(nlohmann_json INTERFACE ${NLOHMANN_JSON_INCLUDE_DIR})
+endif()
+
+# Create alias for compatibility
+if(TARGET nlohmann_json::nlohmann_json AND NOT TARGET nlohmann_json)
+    add_library(nlohmann_json ALIAS nlohmann_json::nlohmann_json)
+endif()
@@
-    find_package(Python COMPONENTS Interpreter Development REQUIRED)
-    FetchContent_Declare(
-        pybind11
-        GIT_REPOSITORY https://github.com/pybind11/pybind11.git
-        GIT_TAG        v2.10.4
-    )
-    FetchContent_MakeAvailable(pybind11)    # target pybind11::pybind11
+    find_package(Python   COMPONENTS Interpreter Development REQUIRED)
+    find_package(pybind11 CONFIG REQUIRED)   # provided by pybind11-dev
+endif()
+
+# Remove any other potential FetchContent calls for pybind11
+if(DEFINED FETCHCONTENT_BASE_DIR AND EXISTS "${FETCHCONTENT_BASE_DIR}/pybind11-subbuild")
+    message(STATUS "Removing existing pybind11 FetchContent directory")
+    file(REMOVE_RECURSE "${FETCHCONTENT_BASE_DIR}/pybind11-subbuild")
+endif()
@@
 endif()
EOF

# Apply patch to CMakeLists.txt
RUN set -e; \
    patch -p1 < /tmp/az_patch.diff; \
    echo "Patch command exited with status $?"

# Configure and build with tests enabled, skipping installation
RUN cmake -S . -B build \
      -DCMAKE_BUILD_TYPE=Release \
      -DTORCH_DIR=${TORCH_DIR} \
      -DCMAKE_PREFIX_PATH="${TORCH_DIR};/usr/share/cmake" \
      -DTorch_DIR=${TORCH_DIR}/share/cmake/Torch \
      -Dpybind11_DIR=/usr/share/cmake/pybind11 \
      -DALPHAZERO_ENABLE_GPU=ON \
      -DALPHAZERO_ENABLE_PYTHON=OFF \
      -DALPHAZERO_BUILD_TESTS=ON \
      -DALPHAZERO_BUILD_EXAMPLES=OFF \
      -DALPHAZERO_SKIP_INSTALL=ON \
      -DCMAKE_CUDA_ARCHITECTURES=86 && \
    cmake --build build -j$(nproc)

# Create script to run tests with more detail
RUN echo '#!/bin/bash\n\
echo "=== Running AlphaZero Tests ==="\n\
echo ""\n\
cd /src\n\
\n\
# Run tests with verbose output\n\
ctest --test-dir /src/build -V "$@"\n\
\n\
# If any tests exist in the build directory, show their output\n\
if find /src/build -name "*_tests" -type f -executable | grep -q .; then\n\
  echo ""\n\
  echo "=== Test Executables Found ==="\n\
  find /src/build -name "*_tests" -type f -executable -exec echo {} \\;\n\
  \n\
  # Directly run each test with more debug info\n\
  echo ""\n\
  echo "=== Running Individual Test Executables ==="\n\
  find /src/build -name "*_tests" -type f -executable -exec {} \\;\n\
fi\n\
\n\
echo ""\n\
echo "=== Tests completed! ==="\n\
' > /src/run-tests.sh && \
    chmod +x /src/run-tests.sh

# Use custom test script as entrypoint
ENTRYPOINT ["/src/run-tests.sh"] 